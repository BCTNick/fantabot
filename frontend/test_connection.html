<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        #log { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <button id="connectBtn">Connect</button>
    <button id="testBtn" disabled>Send Test Message</button>
    
    <h3>Connection Log:</h3>
    <div id="log"></div>

    <script>
        let ws = null;
        let isConnected = false;
        
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const testBtn = document.getElementById('testBtn');
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus(status, message) {
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
            testBtn.disabled = status !== 'connected';
        }
        
        function connect() {
            const ports = [8765, 8766, 8767, 8768, 8769];
            let currentPort = 0;
            
            function tryPort() {
                if (currentPort >= ports.length) {
                    addLog('❌ Failed to connect to any port');
                    updateStatus('disconnected', 'Connection Failed');
                    connectBtn.textContent = 'Retry Connect';
                    return;
                }
                
                const port = ports[currentPort];
                addLog(`🔌 Trying to connect to ws://localhost:${port}`);
                updateStatus('connecting', `Connecting to port ${port}...`);
                
                try {
                    ws = new WebSocket(`ws://localhost:${port}`);
                    
                    ws.onopen = () => {
                        addLog(`✅ Connected to port ${port}`);
                        updateStatus('connected', `Connected to port ${port}`);
                        isConnected = true;
                        connectBtn.textContent = 'Disconnect';
                        
                        // Send initial state request
                        ws.send(JSON.stringify({type: 'get_state'}));
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        addLog(`📨 Received: ${JSON.stringify(data)}`);
                    };
                    
                    ws.onclose = () => {
                        addLog('🔌 Connection closed');
                        updateStatus('disconnected', 'Disconnected');
                        isConnected = false;
                        connectBtn.textContent = 'Connect';
                    };
                    
                    ws.onerror = (error) => {
                        addLog(`❌ Error on port ${port}: ${error}`);
                        currentPort++;
                        setTimeout(tryPort, 1000);
                    };
                    
                } catch (error) {
                    addLog(`❌ Exception on port ${port}: ${error}`);
                    currentPort++;
                    setTimeout(tryPort, 1000);
                }
            }
            
            tryPort();
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function sendTest() {
            if (ws && isConnected) {
                const message = {type: 'get_state'};
                ws.send(JSON.stringify(message));
                addLog(`📤 Sent: ${JSON.stringify(message)}`);
            }
        }
        
        connectBtn.addEventListener('click', () => {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        });
        
        testBtn.addEventListener('click', sendTest);
        
        // Auto-connect on page load
        connect();
    </script>
</body>
</html>
